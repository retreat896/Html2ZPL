<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>V2 Testing</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT"
      crossorigin="anonymous"
    />

    <meta name="description" content="" />
    <meta name="author" content="html blank" />
    <meta name="generator" content="Plain html plus a bit of bootstrap" />

    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
      integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js"
      integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
      crossorigin="anonymous"
    ></script>
    <script src="/konva.js" type="module"></script>
    <link rel="stylesheet" href="./main.css" />
  </head>

  <body>
    <script>
      async function createElement(config, defaults) {
        
        
      }
      $(document).ready(function () {
        var container = document.querySelector("#innerEditor");
        var width = container.offsetWidth;
        var height = container.offsetHeight;
        console.log(width, height);

        var stage = new Konva.Stage({
          container: "#innerEditorCanvas",
          width: width,
          height: height,
        });

        var layer = new Konva.Layer();
        stage.add(layer);

        var textNode = new Konva.Text({
          text: "Some text here",
          x: 800,
          y: 800,
          fontSize: 20,
          draggable: true,
          width: 200,
        });

        layer.add(textNode);

        var tr = new Konva.Transformer({
          node: textNode,
          enabledAnchors: ["middle-left", "middle-right"],
          // set minimum width of text
          boundBoxFunc: function (oldBox, newBox) {
            newBox.width = Math.max(30, newBox.width);
            return newBox;
          },
        });

        textNode.on("transform", function () {
          // reset scale, so only with is changing by transformer
          textNode.setAttrs({
            width: textNode.width() * textNode.scaleX(),
            scaleX: 1,
          });
        });

        layer.add(tr);

        textNode.on("dblclick dbltap", () => {
          // hide text node and transformer:
          textNode.hide();
          tr.hide();

          // create textarea over canvas with absolute position
          // first we need to find position for textarea
          // how to find it?

          // at first lets find position of text node relative to the stage:
          var textPosition = textNode.absolutePosition();

          // so position of textarea will be the sum of positions above:
          var areaPosition = {
            x: stage.container().offsetLeft + textPosition.x,
            y: stage.container().offsetTop + textPosition.y,
          };

          // create textarea and style it
          var textarea = document.createElement("textarea");
          document.body.appendChild(textarea);

          // apply many styles to match text on canvas as close as possible
          // remember that text rendering on canvas and on the textarea can be different
          // and sometimes it is hard to make it 100% the same. But we will try...
          textarea.value = textNode.text();
          textarea.style.position = "absolute";
          textarea.style.top = areaPosition.y + "px";
          textarea.style.left = areaPosition.x + "px";
          textarea.style.width =
            textNode.width() - textNode.padding() * 2 + "px";
          textarea.style.height =
            textNode.height() - textNode.padding() * 2 + 5 + "px";
          textarea.style.fontSize = textNode.fontSize() + "px";
          textarea.style.border = "none";
          textarea.style.padding = "0px";
          textarea.style.margin = "0px";
          textarea.style.overflow = "hidden";
          textarea.style.background = "none";
          textarea.style.outline = "none";
          textarea.style.resize = "none";
          textarea.style.lineHeight = textNode.lineHeight();
          textarea.style.fontFamily = textNode.fontFamily();
          textarea.style.transformOrigin = "left top";
          textarea.style.textAlign = textNode.align();
          textarea.style.color = textNode.fill();
          rotation = textNode.rotation();
          var transform = "";
          if (rotation) {
            transform += "rotateZ(" + rotation + "deg)";
          }

          var px = 0;
          // also we need to slightly move textarea on firefox
          // because it jumps a bit
          var isFirefox =
            navigator.userAgent.toLowerCase().indexOf("firefox") > -1;
          if (isFirefox) {
            px += 2 + Math.round(textNode.fontSize() / 20);
          }
          transform += "translateY(-" + px + "px)";

          textarea.style.transform = transform;

          // reset height
          textarea.style.height = "auto";
          // after browsers resized it we can set actual value
          textarea.style.height = textarea.scrollHeight + 3 + "px";

          textarea.focus();

          function removeTextarea() {
            textarea.parentNode.removeChild(textarea);
            window.removeEventListener("click", handleOutsideClick);
            textNode.show();
            tr.show();
            tr.forceUpdate();
          }

          function setTextareaWidth(newWidth) {
            if (!newWidth) {
              // set width for placeholder
              newWidth = textNode.placeholder.length * textNode.fontSize();
            }
            // some extra fixes on different browsers
            var isSafari = /^((?!chrome|android).)*safari/i.test(
              navigator.userAgent
            );
            var isFirefox =
              navigator.userAgent.toLowerCase().indexOf("firefox") > -1;
            if (isSafari || isFirefox) {
              newWidth = Math.ceil(newWidth);
            }

            var isEdge =
              document.documentMode || /Edge/.test(navigator.userAgent);
            if (isEdge) {
              newWidth += 1;
            }
            textarea.style.width = newWidth + "px";
          }

          textarea.addEventListener("keydown", function (e) {
            // hide on enter
            // but don't hide on shift + enter
            if (e.keyCode === 13 && !e.shiftKey) {
              textNode.text(textarea.value);
              removeTextarea();
            }
            // on esc do not set value back to node
            if (e.keyCode === 27) {
              removeTextarea();
            }
          });

          textarea.addEventListener("keydown", function (e) {
            scale = textNode.getAbsoluteScale().x;
            setTextareaWidth(textNode.width() * scale);
            textarea.style.height = "auto";
            textarea.style.height =
              textarea.scrollHeight + textNode.fontSize() + "px";
          });

          function handleOutsideClick(e) {
            if (e.target !== textarea) {
              textNode.text(textarea.value);
              removeTextarea();
            }
          }
          setTimeout(() => {
            window.addEventListener("click", handleOutsideClick);
          });
        });
      });
    </script>
    <div id="page">
      <div id="nav">nav</div>

      <div id="content">
        <div id="left">
          <div id="innerLeft" class="collapse-horizontal collapse">
            <div class="inner">
              <p>
                Zoom:
                <button type="button" id="zoomIn">Zoom In (+)</button>
                <button type="button" id="zoomOut">Zoom Out (-)</button>
                <button type="button" id="resetZoom">Reset Zoom</button>
              </p>
            </div>
          </div>
          <button
            class="btn bg-secondary text-white toggle"
            data-bs-toggle="collapse"
            data-bs-target="#innerLeft"
          ></button>
          <div
            data-krus-target="#innerLeft|#innerLeft .inner"
            class="resize-bar-v"
          ></div>
        </div>
        <div id="editor">
          <div id="innerEditor">
            <div id="innerEditorCanvas"></div>
          </div>
        </div>

        <div id="right">
          <div
            data-krus-target="#innerRight|#innerRight .inner"
            class="resize-bar-v"
          ></div>
          <button
            class="btn bg-secondary text-white toggle"
            data-bs-toggle="collapse"
            data-bs-target="#innerRight"
          ></button>
          <div id="innerRight" class="collapse-horizontal collapse">
            <div class="inner">
              <p>
                Click and drag to move the image.
                <button type="button" id="resetPos">Reset Position</button>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
