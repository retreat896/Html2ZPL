<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>V2 Testing</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT"
      crossorigin="anonymous"
    />

    <meta name="description" content="" />
    <meta name="author" content="html blank" />
    <meta name="generator" content="Plain html plus a bit of bootstrap" />

    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
      integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js"
      integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
      crossorigin="anonymous"
    ></script>

    <link rel="stylesheet" href="./main.css" />
  </head>

  <body>
    <script>
      document.addEventListener(
        "DOMContentLoaded",
        function (e) {
          // Canvas
          var mouseDown = false;
          var mousePos = [0, 0];
          var canvas = document.querySelector("#innerEditorCanvas");
          canvas.width = document.querySelector("#editor").clientWidth;
          canvas.height = document.querySelector("#editor").clientHeight - 10;

          let dvdx = canvas.width / 2;
          let dvdy = canvas.height / 2;
          let dvddx = (Math.random() - 0.5) * 4; // Random initial velocity
          let dvddy = (Math.random() - 0.5) * 4;
          let dvdspeed = Math.min(5, Math.max(1, (Math.random()*10)));
          console.log("dvdspeed", dvdspeed);
          const dvdradius = 20;
          const dvdcolors = ['red', 'green', 'blue', 'yellow', 'orange'];
          let dvdcolorIndex = 0;

          var context = canvas.getContext("2d");
          canvas.addEventListener("mousewheel", zoom, false);
          canvas.addEventListener("mousedown", setMouseDown, false);
          canvas.addEventListener("mouseup", setMouseUp, false);
          canvas.addEventListener("mousemove", move, false);

          // Defaults
          var DEFAULT_ZOOM = 0.5;
          var MAX_ZOOM = 3;
          var MIN_ZOOM = 0.2;
          var ZOOM_STEP = 0.1;
          var DRAW_POS = [canvas.width / 2, canvas.height / 2];

          // Buttons
          var zoomInBtn = document.querySelector("#zoomIn");
          zoomInBtn.addEventListener("click", zoomIn, false);
          var zoomOutBtn = document.querySelector("#zoomOut");
          zoomOutBtn.addEventListener("click", zoomOut, false);
          var resetZoomBtn = document.querySelector("#resetZoom");
          resetZoomBtn.addEventListener("click", resetZoom, false);
          var resetPosBtn = document.querySelector("#resetPos");
          resetPosBtn.addEventListener("click", resetPos, false);

          // Image
          var loaded = false;
          var drawPos = DRAW_POS;
          var scale = DEFAULT_ZOOM;
          var image = new Image();
          image.src = "./image.jpg";
          image.addEventListener(
            "load",
            function (e) {
              loaded = true;
              requestAnimationFrame(drawCanvas);
            },
            false
          );

          //Draw the canvas
          function drawCanvas() {
            context.fillStyle = "#FFFFFF";
            context.fillRect(0, 0, canvas.width, canvas.height);
            if (loaded) {
              drawImage();
              context.beginPath();
            context.arc(dvdx, dvdy, dvdradius, 0, 2 * Math.PI);
            context.fillStyle = dvdcolors[dvdcolorIndex];
            context.fill();

            // Update position
            dvdx += dvddx*dvdspeed;
            dvdy += dvddy*dvdspeed;

            // Reverse direction if hitting the edges
            if (dvdx + dvdradius > canvas.width || dvdx - dvdradius < 0) {
              dvddx = -dvddx;
              dvdcolorIndex = (dvdcolorIndex + 1) % dvdcolors.length;
            }
            if (dvdy + dvdradius > canvas.height || dvdy - dvdradius < 0) {
              dvddy = -dvddy;
              dvdcolorIndex = (dvdcolorIndex + 1) % dvdcolors.length;
            }
            
            }
            
            requestAnimationFrame(drawCanvas);
          }

          // Draw the image
          function drawImage() {
            var w = image.width * scale;
            var h = image.height * scale;

            var x = drawPos[0] - w / 2;
            var y = drawPos[1] - h / 2;
            context.drawImage(image, x, y, w, h);
          }

          // Set the zoom with the mouse wheel
          function zoom(e) {
            if (e.wheelDelta > 0) {
              zoomIn();
            } else {
              zoomOut();
            }
          }

          // Zoom in
          function zoomIn(e) {
            if (scale < MAX_ZOOM) {
              scale += ZOOM_STEP;
              //drawCanvas();
            }
          }

          // Zoom out
          function zoomOut(e) {
            if (scale > MIN_ZOOM) {
              scale -= ZOOM_STEP;
              //drawCanvas();
            }
          }

          // Reset the zoom
          function resetZoom(e) {
            scale = DEFAULT_ZOOM;
            //drawCanvas();
          }

          // Reset the position
          function resetPos(e) {
            drawPos = DRAW_POS;
            //drawCanvas();
          }

          // Toggle mouse status
          function setMouseDown(e) {
            mouseDown = true;
            mousePos = [e.x, e.y];
            $(".inner").css("pointer-events", "none");
          }
          function setMouseUp(e) {
            mouseDown = false;
            $(".inner").css("pointer-events", "all");
          }

          // Move
          function move(e) {
            if (mouseDown) {
              var delta = [e.x - mousePos[0], e.y - mousePos[1]];
              drawPos = [drawPos[0] + delta[0], drawPos[1] + delta[1]];
              mousePos = [e.x, e.y];
              drawCanvas();
            }
          }
          
        },
        true
      );
    </script>

    <script type="text/javascript">
      $(document).ready(function () {
        let target = null;
        let isHandlerDragging = false;

        $(document).on("mousedown", ".resize-bar-v", function (e) {
          isHandlerDragging = true;
          target = $(this).attr("data-krus-target");
          e.preventDefault(); // Prevent default action
        });

        $(document).on("mousemove", function (e) {
          if (!isHandlerDragging) {
            return;
          }

          if (target) {
            let temptarget = target;
            console.log(target);
            if (target.split("|").length != 1) {
              temptarget = target.split("|")[0];
            }
            const minWidth = 200; // Minimum width of the target element
            let offset; // Get the target element's left offset
            const pointerPosition = e.clientX;
            let newWidth;
            if (temptarget == "#innerLeft") {
              offset = $(temptarget).offset().left;
              newWidth = Math.min(
                500,
                Math.max(minWidth, pointerPosition - offset)
              );
            } else if (temptarget == "#innerRight") {
              offset = document
                .getElementById(temptarget.replace("#", ""))
                .getBoundingClientRect().right;
              newWidth = Math.min(
                500,
                Math.max(minWidth, offset - pointerPosition) - 20
              );
            } else {
              offset = $(temptarget).offset().left;
              newWidth = Math.min(
                500,
                Math.max(minWidth, pointerPosition - offset)
              );
            }
            // Get the current pointer position

            // Resize the target element based on the pointer position
            if (target.split("|").length == 1) {
              $(temptarget).css("width", newWidth + "px");
            } else {
              var bodyStyles = window.getComputedStyle(document.body);
              var innermargin = bodyStyles.getPropertyValue("--inner-margin");
              $(target.split("|")[0]).css("width", newWidth + "px");
              $(target.split("|")[1]).css(
                "width",
                newWidth - innermargin.replace("px", "") * 2 + "px"
              );
              console.log(
                "width",
                newWidth - innermargin.replace("px", "") * 2 + "px"
              );
            }
          }
        });

        $(document).on("mouseup", function () {
          isHandlerDragging = false;
          target = null; // Clear the target when mouse is released
        });
      });
    </script>
    <div id="page">
      <div id="nav">nav</div>

      <div id="content">
        <div id="left">
          <div id="innerLeft" class="collapse-horizontal collapse">
            <div class="inner">
              <p>
                Zoom:
                <button type="button" id="zoomIn">Zoom In (+)</button>
                <button type="button" id="zoomOut">Zoom Out (-)</button>
                <button type="button" id="resetZoom">Reset Zoom</button>
              </p>
            </div>
          </div>
          <button
            class="btn bg-secondary text-white toggle"
            data-bs-toggle="collapse"
            data-bs-target="#innerLeft"
          ></button>
          <div
            data-krus-target="#innerLeft|#innerLeft .inner"
            class="resize-bar-v"
          ></div>
        </div>
        <div id="editor">
          <div id="innerEditor"><canvas id="innerEditorCanvas"></canvas></div>
        </div>

        <div id="right">
          <div
            data-krus-target="#innerRight|#innerRight .inner"
            class="resize-bar-v"
          ></div>
          <button
            class="btn bg-secondary text-white toggle"
            data-bs-toggle="collapse"
            data-bs-target="#innerRight"
          ></button>
          <div id="innerRight" class="collapse-horizontal collapse">
            <div class="inner">
              <p>
                Click and drag to move the image.
                <button type="button" id="resetPos">Reset Position</button>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
